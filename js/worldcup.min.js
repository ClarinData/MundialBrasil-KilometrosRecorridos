/*! worldcup 2014-07-03 */
function drawBar(a,b){var c=b.team?b.team.split(/\s+/):[];b.totalDistance=b.team?b.totalDistance:0;var d=a.select("text.bar_title");for(d.selectAll("tspan").remove(),d.transition().attr({x:30,y:inverseLinearScale(b.totalDistance)-24});c.length>0;)d.append("tspan").attr({x:30,dy:"-1.1em"}).text(c.pop()||"");a.select("use").transition().attr("transform",function(){var a=inverseLinearScale(b.totalDistance)-126;return"matrix(1 0 0 1 0 "+a+")"}),a.select("rect").transition().attr({y:inverseLinearScale(b.totalDistance),height:function(){var a=linearScale(b.totalDistance)-80;return a=0>a?0:a}}),a.select("text.bar_details").transition().attr({x:30,y:inverseLinearScale(b.totalDistance)-16}).text(b.totalDistance+" KM")}var svg=d3.select("svg#map").attr({width:function(){return this.clientWidth||this.parentElement.clientWidth},height:function(){return this.clientHeight||this.parentElement.clientHeight},viewBox:function(){return"0 0 "+(this.clientWidth||this.parentElement.clientWidth)+" "+(this.clientHeight||this.parentElement.clientHeight)}}),width=parseFloat(svg.attr("width")),height=parseFloat(svg.attr("height"));window.addEventListener("resize",function(){svg.attr({width:function(){return this.clientWidth||this.parentElement.clientWidth},height:function(){var a=this.clientWidth||this.parentElement.clientWidth,b=this.clientHeight||this.parentElement.clientHeight;return a*(b/a)}}),width=parseFloat(svg.attr("width")),height=parseFloat(svg.attr("height"))});var projection=d3.geo.mercator().center([0,-15]).rotate([52,0]).scale(74*height/55).translate([width/2,height/2]),path=d3.geo.path().projection(projection),tile=d3.geo.tile().size([width,height]).scale(2*projection.scale()*Math.PI).translate(projection([0,0])).zoomDelta((window.devicePixelRatio||1)-.5),map=svg.append("g").attr("id","map"),lines=svg.append("g").attr("id","lines"),poi=svg.append("g").attr("id","poi"),tooltips=svg.append("g").attr("id","tooltips"),axis=d3.select("#barAxis").select("svg").attr("height",function(){return this.clientHeight||this.parentElement.clientHeight}).select("g").attr("transform","translate(0,-10)"),bar1=d3.select("#bar1").select("svg").attr("height",function(){return this.clientHeight||this.parentElement.clientHeight}).select("g"),bar2=d3.select("#bar2").select("svg").attr("height",function(){return this.clientHeight||this.parentElement.clientHeight}).select("g"),definitions=svg.append("defs"),geoRef={stadium:{},concentration:{}},barSize=[70,600],weather={},stad=definitions.append("g").attr({id:"stadium-marker",transform:"translate(-10,-10)"});stad.append("circle").attr({cx:11.614,cy:11.614,r:10,fill:"#73C5E4",stroke:"white","stroke-width":"1.5px"}),stad.append("circle").attr({cx:11.614,cy:11.614,r:7,fill:"black","fill-opacity":".7",stroke:"white","stroke-width":"1.5px"}),definitions.append("g").attr("id","concentration-marker").append("circle").attr({cx:0,cy:0,r:4}),definitions.append("g").attr("id","plane").append("path").attr("d","M28.288,117.296v4.877l-7.129,4.455v1.744l7.129-2.303v4.111l-1.643,1.432v1.348l2.564-0.924l2.563,0.924v-1.348l-1.641-1.432v-4.111l7.129,2.303v-1.744l-7.129-4.455v-4.877c0-0.6-0.416-1.092-0.922-1.092C28.702,116.205,28.288,116.697,28.288,117.296z"),[bar1,bar2].forEach(function(a){a.append("rect").attr({"class":"bar_line",x:25.5,y:barSize[1],width:7.755,height:0});var b=(a.append("text").attr({x:30,y:barSize[1]-43,"class":"bar_title"}),"matrix(1 0 0 1 0 "+(parseFloat(barSize[1])-126)+")");a.append("use").attr({"class":"bar_icon","xlink:href":"#plane",transform:b}),a.append("text").attr({x:30,y:barSize[1]-16,"class":"bar_details"}).text("0 KM")});var linearScale=function(){return 136},inverseLinearScale=function(){return 136};queue().defer(d3.json,"data/map.json").defer(d3.json,"data/poi.json").defer(d3.json,"data/teams.json").awaitAll(function(a,b){var c=tile();map.append("g").attr("id","backtiles").selectAll("image").data(c).enter().append("image").attr({"xlink:href":function(a){return"tiles/2/"+a[2]+"/"+a[0]+"/"+a[1]+".jpg"},width:Math.round(c.scale),height:Math.round(c.scale),x:function(a){return Math.round((a[0]+c.translate[0])*c.scale)},y:function(a){return Math.round((a[1]+c.translate[1])*c.scale)}}),map.insert("path").datum(topojson.feature(b[0],b[0].objects.land)).attr({"class":"land",id:"land",d:path}),svg.append("clipPath").attr({id:"clip","xlink:xlink:href":"#land"}).append("use"),poi.selectAll(".poi").data(b[1].features.sort(function(a,b){return"stadium"==b.domain?-1:1})).enter().append("use").attr({id:function(a){return a.properties.type+"."+("stadium"==a.properties.type?a.properties.city:a.properties.team)},"xlink:xlink:href":function(a){return"#"+a.properties.type+"-marker"},"class":function(a){return geoRef[a.properties.type][a.properties.city]=a.geometry.coordinates,a.properties.type+" marker poi"},x:function(a){return path.centroid(a)[0]},y:function(a){return path.centroid(a)[1]}}).text(function(a){return a.properties.city}).on({mouseover:function(a){var b=d3.select("#tooltip_stadium_"+a.name.replace(/\s|\(|\)/g,"_")).classed("disabled",!1);d3.select("g[id ^=tooltip_concentration]").classed("disabled",function(){return"concentration"!=a.domain}),d3.json("http://api.openweathermap.org/data/2.5/weather?lang=sp&units=metric&lat="+a.geometry.coordinates[1]+"&lon="+a.geometry.coordinates[0],function(a){b.select(".temp.max").text("Temperatura max: "+Math.round(a.main.temp_max)+"°C")})},mouseout:function(a){d3.select("#tooltip_stadium_"+a.name.replace(/\s|\(|\)/g,"_")).classed("disabled",!0),d3.select("g[id ^=tooltip_concentration]").classed("disabled",!1),drawBar(bar2,{team:"",totalDistance:0})}});var d=function(a,b){var c=function(a){return a.event=d3.dispatch("selected","mouseover","mouseout","menuout"),function(c){return c.nodes=function(b){return b.append("div").attr("class",function(a){return"Group"+a.group}).append("div").attr("class",function(a){return"menuitem radio "+a.team.replace(/\s+|\.+/g,"_").toLowerCase()+(a.status?" "+a.status:"")}).on({mouseover:function(b){"teamActive"!=this.id&&a.event.mouseover(b)},mouseout:function(){a.event.mouseover(null)},click:function(b){var c=document.getElementById("teamActive");this.hasAttribute("id")?(this.removeAttribute("id"),a.event.selected(null)):(c&&c.removeAttribute("id"),this.id="teamActive",a.event.selected(b))}}).call(function(){b.labels=this.append("label").text(function(a){return a.team})}),b}(c.append("g").data(b).enter()),c}(a.selectAll(".menuitem")),a}(d3.select(a));return c},e={},f=d3.keys(b[2]).map(function(a){return b[2][a].team=a,b[2][a].totalDistance=2*b[2][a].games.map(function(a){return a.distance}).reduce(function(a,b){return a+b}),b[2][a]}),g=d3.max(f,function(a){return a.totalDistance});linearScale=d3.scale.linear().domain([0,g]).range(barSize),inverseLinearScale=d3.scale.linear().domain([0,g]).range(barSize.reverse());var h=d3.svg.axis().scale(inverseLinearScale).orient("right").tickSize(130).tickFormat(function(a){return a+(a?"":" Km")}).ticks(12),i=(axis.call(h),[]);f.map(function(a){var b=d3.select("use[id='concentration."+a.team+"']");i=(i||[]).concat(a.games.map(function(c){var d=d3.select("use[id='stadium."+c.stadium+"']");return{properties:{team:a.team},coordinates:[[b.attr("x"),b.attr("y")],[d.attr("x"),d.attr("y")]]}}))}),lines.selectAll(".routes").data(i).enter().append("line").attr({id:function(a,b){return"route."+a.properties.team+"."+b},"class":"line routes disabled",x1:function(a){return a.coordinates[0][0]},y1:function(a){return a.coordinates[0][1]},x2:function(a){return a.coordinates[1][0]},y2:function(a){return a.coordinates[1][1]}}),e=new d("#menu",f),e.event.on("selected",function(a){a&&(a.stadiums=a.games.map(function(a){return a.stadium})),a?(drawBar(bar1,a),drawBar(bar2,{team:"",totalDistance:0})):drawBar(bar1,{team:"",totalDistance:0});var b=d3.selectAll("use[id^=concentration],use[id^=stadium],line[id^=route]");b.datum(function(b){var c=this.getAttribute("id").split("."),d="route"==c[0]&&a&&a.team==c[1],e="route"!=c[0]&&(!a||a.team==c[1]||a.stadiums.indexOf(c[1])>-1);return b.selected=d||e,b.domain=c[0],b.name=c[1],b.gravity=b.anchor,b.oponent=a&&a.games[a.stadiums.indexOf(c[1])]?a.games[a.stadiums.indexOf(c[1])].oponent:null,b}).classed("disabled",function(a){return!a.selected}).classed("selected",function(b){return a&&b.selected}).classed("over",!1);var c=d3.selectAll("g.tooltip");c.remove();var d=d3.selectAll("use[id^=concentration]:not(.disabled),use[id^=stadium]:not(.disabled)");d.each(function(b){var c="concentration"==b.domain?83:-10,d=150,e=62;if(b.selected&&a){var f=d3.select(this),g=tooltips.datum(function(){return f}).append("g").attr({"class":"tooltip "+b.domain,id:"tooltip_"+b.domain+"_"+b.name.replace(/\s|\(|\)/g,"_")}).classed("disabled",function(){return"concentration"!=b.domain&&b.name!=a.team}),h=g.sort(function(a,b){return parseFloat(b.attr("x"))-parseFloat(a.attr("x"))}).append("g").on({mouseover:function(){d3.select(this).classed("hidden",function(a){return"concentration"!=a.domain})},mouseout:function(){d3.select(this).classed("hidden",function(a){return"concentration"==a.domain})}}).attr({viewBox:"0 0 "+width+" "+height,transform:function(a){return a.width=d,a.height=e,a.x=parseFloat(a.attr("x"))-d/2,a.y=parseFloat(a.attr("y"))-e-10,a.y=a.y<0||a.y>height-e-10?height-e+c:a.y+c,a.x=a.x<0||a.x>width-d-10?width-d-10:a.x,a.anchor={w:[a.x,a.y+a.height/2],n:[a.x+a.width/2,a.y],e:[a.x+a.width,a.y+a.height/2],s:[a.x+a.width/2,a.y+a.height]},a.weight=1,a.gravity="s","translate("+a.x+", "+a.y+")"}}),i=h.append("rect").attr({"class":"box disable-hover",x:0,y:0,width:d,height:e});"concentration"==b.domain?(h.append("text").attr({"class":"team  disable-hover",x:5,y:35}).text(a.team),h.append("text").attr({"class":"city disable-hover",x:5,y:52}).text(a.concentration),h.append("text").attr({"class":"type disable-hover",x:5,y:17}).text("Concentración")):(h.append("text").attr({"class":"stadium disable-hover",x:5,y:17}).text(b.name),h.append("text").attr({"class":"opponent disable-hover",x:5,y:57}).text(function(){var c=a.games.map(function(a){return a.stadium==b.name?a.oponent:null}).reduce(function(a,b){return a=Array.isArray(a)?a:a?[a]:[],b&&a.push(b),a}).join(" / "),e=a.team+"  vs.  "+c;return console.log(b.name,a.games,c),i.attr({width:Math.max(5*e.length+6,d)}),e}),h.append("rect").attr({"class":"box distance disable-hover",x:5,y:22,width:55,height:20}),h.append("text").attr({"class":"distance disable-hover",x:9,y:37}).text(function(){var c=a.stadiums.indexOf(b.name);return a.games[c].distance+" Km"}))}}).classed("disabled",function(a){return!a.selected})}),e.event.on("mouseover",function(a){a&&(a.stadiums=a.games.map(function(a){return a.stadium})),d3.selectAll("use[id^=concentration],use[id^=stadium],line[id^=route]").datum(function(b){var c=this.getAttribute("id").split("."),d="route"==c[0]&&a&&a.team==c[1],e="route"!=c[0]&&(!a||a.team==c[1]||a.stadiums.indexOf(c[1])>-1);return b.over=d||e,b.domain=c[0],b.name=c[1],b.route=d,b}).classed({over:function(b){return a&&!b.selected&&b.over},disabled:function(b){return!a&&!b.selected||!b.selected&&!b.over}}),a?drawBar(bar2,a):drawBar(bar2,{team:"",totalDistance:0})})});